---
title: "03/04/2020 Work"
output:
  html_document:
    df_print: paged
---

```{r Setup, include=FALSE}
library(ggplot2)
library(gridExtra)
library(ncdf4)
library(dplyr)
```


Today, I will perform some simple tests to confirm whether there is any correlation
between antecedent rainfall and temperature and GPP/NPP/NEE.

I will use simple methods to test for relationship between productivity and rainfall
(maybe temperature) from a few months ago.

My methodology will be as below:

+ Propose a few methods of searching for correlations
+ Check my methods using Kiona's data (which we are fairly certain have these
correlations)
+ Use the methods on Var and Wkg FLUXNET data for NEE and GPP and see what we see!

***

# Data

First of all, let's load in the data.

```{r Data Import}

#Load Kiona's Data
Precip = read.table("data/dataset3.csv",header=TRUE,stringsAsFactors = FALSE)
NPP = read.table("data/dataset2.csv",header=TRUE,stringsAsFactors = FALSE)
NPP = NPP[,1:3]

#Prepare to load netcdf files for fluxnet sites
source("NCExtraction.R")

Var = NetCDFExtract("US-Var_2001-2014_FLUXNET2015")
Wkg = NetCDFExtract("US-Wkg_2005-2014_FLUXNET2015")
Ha1 = NetCDFExtract("US-Ha1_1992-2012_FLUXNET2015")

```

***

# Methodology

Gab and Martin suggested a variety of methods. I will use the below:

+ Calculate correlation between yearly precip and NPP for each previous year





***

## Correlation between NPP and Lagged Yearly Precip

We take the total yearly NPP from year i. We calculate the correlation between
this and total yearly precipitaiton from years i,i-1,... for as far back as the 
dataset allowed.

Below we first check Kiona's data (Fort Collins) as studies have shown that precip
from the last five years has an effect on the NPP of the current year.

```{r Fort Collins Yearly Corr}
# Set values for years of NPP data and max possible lag (i.e. max number of 
# previous years of precip data that is available for all NPP observations)
NPPYrs = 52
MaxLag = 40
#Initiliase vectors
YearlyCorrelation = rep(0,MaxLag)
YearlyPValue = rep(0,MaxLag)
YearlyMin = rep(0,MaxLag)
YearlyMax = rep(0,MaxLag)
# For each possible lag (at most we can go 40 years back), check correlation of
# yearly total NPP vs yearly total precipitation
# We have 52 years of NPP so we want 52 years of Precip, hence i:(i+51)

for (i in 1:MaxLag){
  Stats = cor.test(NPP$NPP,rowSums(Precip[i:(i+NPPYrs-1),2:13]),use="complete.obs")
  YearlyCorrelation[i] = Stats$estimate
  YearlyPValue[i] = (Stats$p.value<=0.05)
  YearlyMin[i] = Stats$conf.int[1]
  YearlyMax[i] = Stats$conf.int[2]
}



# Assemble into dataframe
# Reverse vectors so that from left to right, we are moving further into the past
LagCorrelation = data.frame(0:(MaxLag-1),
                    Correlation=rev(YearlyCorrelation),
                    pValue=rev(YearlyPValue),
                    min = rev(YearlyMin), 
                    max = rev(YearlyMax))

# Plot correlation values with confidence intervals. Color red if p <= 0.05 i.e.
# there is a significant correlation
plot <- ggplot(LagCorrelation,aes(x=0:(MaxLag-1),
                          y=Correlation,
                          color=pValue,
                          ymin = min, 
                          ymax = max)) + 
  geom_pointrange() +
  scale_color_continuous(low="black",
                         high="red",
                         guide="none") +
  geom_hline(yintercept=0,
             color="grey",
             linetype='dashed') +
  xlab("Year into Past") +
  ggtitle("Yearly Total Precip vs NPP Correlation (Site: Fort Collins)")
grid.arrange(plot)
```

As can be seen from the graph, the previous 3 years of rainfall (i, i-1, i-2) 
are significantly correlated to the NPP in year i. This agrees with Kiona's paper
and my previous work with the model investigating the ideal lag period.

The two other significant lags at i-13 and i-20 seem unlikely to be supported by
any mechanistic reason within the grassland although it is possible. 

Since this method appears to provide a sanity check on the antecedent rainfall 
being important for productivity, I will now apply it to the fluxnet sites.

```{r Vaira Yearly Corr NEE}
# Set values for years of NEE data and max possible lag (i.e. max number of 
# previous years of precip data that is available for all NPP observations)
NEEYrs = 14
MaxLag = 4
#Initiliase vectors
YearlyCorrelation = rep(0,MaxLag)
YearlyPValue = rep(0,MaxLag)
YearlyMin = rep(0,MaxLag)
YearlyMax = rep(0,MaxLag)
# For each possible lag check correlation of yearly total NEE vs yearly total 
# precipitation

for (i in 1:(MaxLag+1)){
  Stats = cor.test(Var$NEE[i:NEEYrs,2],
                   rowSums(Var$Precip[1:(NEEYrs-i+1),2:13]),
                   use="complete.obs")
  YearlyCorrelation[i] = Stats$estimate
  YearlyPValue[i] = Stats$p.value<=0.05
  YearlyMin[i] = Stats$conf.int[1]
  YearlyMax[i] = Stats$conf.int[2]
}


# Assemble into dataframe
# Reverse vectors so that from left to right, we are moving further into the past
LagCorrelation = data.frame(0:MaxLag,
                            Correlation=rev(YearlyCorrelation),
                            pValue=rev(YearlyPValue),
                            min = rev(YearlyMin), 
                            max = rev(YearlyMax))

# Plot correlation values with confidence intervals. Color red if p <= 0.05 i.e.
# there is a significant correlation
plot <- ggplot(LagCorrelation,aes(x=0:MaxLag,
                          y=Correlation,
                          color=pValue,
                          ymin = min, 
                          ymax = max)) + 
  geom_pointrange() +
  scale_color_continuous(low="black",
                         high="red",
                         guide="none") +
  geom_hline(yintercept=0,
             color="grey",
             linetype='dashed') +
  xlab("Year into Past") +
  ggtitle("Yearly Total Precip vs NEE Correlation (Site: Vaira Grasslands)")
grid.arrange(plot)
```

As can be seen, there is no significant correlation at ANY lag between NEE and
precip at Vaira. This clearly implies that NEE is not a good metric - it is 
generally accepted that grasslands tend to be water-limited and productivity is
highly driven by rainfall. We would definitely expect to at least see a correlation
for a lag of 0 years (i.e. rainfall in year i against production in year i)

This would likely explain why I've been having issues with my model for the 
FLUXNET sites.

Let's try again, but this time with GPP:

```{r Vaira Yearly Corr GPP}
# Set values for years of GPP data and max possible lag (i.e. max number of 
# previous years of precip data that is available for all GPP observations)
GPPYrs = 14
MaxLag = 4
#Initiliase vectors
YearlyCorrelation = rep(0,MaxLag)
YearlyPValue = rep(0,MaxLag)
YearlyMin = rep(0,MaxLag)
YearlyMax = rep(0,MaxLag)
# For each possible lag check correlation of yearly total GPP vs yearly total 
# precipitation

for (i in 1:(MaxLag+1)){
  Stats = cor.test(Var$GPP[i:GPPYrs,2],
                   rowSums(Var$Precip[1:(GPPYrs-i+1),2:13]),
                   use="complete.obs")
  YearlyCorrelation[i] = Stats$estimate
  YearlyPValue[i] = Stats$p.value<=0.05
  YearlyMin[i] = Stats$conf.int[1]
  YearlyMax[i] = Stats$conf.int[2]
}

# Assemble into dataframe
# Reverse vectors so that from left to right, we are moving further into the past
LagCorrelation = data.frame(0:MaxLag,
                            Correlation=YearlyCorrelation,
                            pValue=YearlyPValue,
                            min = YearlyMin, 
                            max = YearlyMax)

# Plot correlation values with confidence intervals. Color red if p <= 0.05 i.e.
# there is a significant correlation
plot <- ggplot(LagCorrelation,
               aes(x=0:MaxLag,
                   y=Correlation,
                   color=pValue,
                   ymin = min, 
                   ymax = max)) + 
  geom_pointrange() +
  scale_color_continuous(low="black",
                         high="red",
                         guide="none") +
  geom_hline(yintercept=0,
             color="grey",
             linetype='dashed') +
  xlab("Year into Past") +
  ggtitle("Yearly Total Precip vs GPP Correlation (Site: Vaira Grasslands)")
grid.arrange(plot)
```

Hm, this isn't too different. The correlation at lag 0 is nearly significant but
isn't (p=0.08)

```{r Walnut Gulch Yearly Corr GPP}
# Set values for years of GPP data and max possible lag (i.e. max number of 
# previous years of precip data that is available for all GPP observations)
GPPYrs = 10
MaxLag = 4
#Initiliase vectors
YearlyCorrelation = rep(0,MaxLag)
YearlyPValue = rep(0,MaxLag)
YearlyMin = rep(0,MaxLag)
YearlyMax = rep(0,MaxLag)
# For each possible lag check correlation of yearly total GPP vs yearly total 
# precipitation

for (i in 1:(MaxLag+1)){
  Stats = cor.test(Wkg$GPP[i:GPPYrs,2],
                   rowSums(Wkg$Precip[1:(GPPYrs-i+1),2:13]),
                   use="complete.obs")
  YearlyCorrelation[i] = Stats$estimate
  YearlyPValue[i] = Stats$p.value<=0.05
  YearlyMin[i] = Stats$conf.int[1]
  YearlyMax[i] = Stats$conf.int[2]
}

# Assemble into dataframe
# Reverse vectors so that from left to right, we are moving further into the past
LagCorrelation = data.frame(0:MaxLag,
                            Correlation=YearlyCorrelation,
                            pValue=YearlyPValue,
                            min = YearlyMin, 
                            max = YearlyMax)

# Plot correlation values with confidence intervals. Color red if p <= 0.05 i.e.
# there is a significant correlation
plot <- ggplot(LagCorrelation,
               aes(x=0:MaxLag,
                   y=Correlation,
                   color=pValue,
                   ymin = min, 
                   ymax = max)) + 
  geom_pointrange() +
  scale_color_continuous(low="black",
                         high="red",
                         guide="none") +
  geom_hline(yintercept=0,
             color="grey",
             linetype='dashed') +
  xlab("Year into Past") +
  ggtitle("Yearly Total Precip vs GPP Correlation (Site: Walnut Gulch)")
grid.arrange(plot)
```

Here we go! A significant correlation between lag 0 rainfall and productivity 
which could be reasonably hypothesised. No significant correlation at longer lags
however.

Next we check Harvard Forest. I'd expect this to not exhibit any correlations
at any lag due to the longer time scales over which forests tend to respond
to meteorological drivers (e.g. soil water providing a buffer from lack of rain)

```{r Harvard Forest Yearly Corr GPP}
# Set values for years of GPP data and max possible lag (i.e. max number of 
# previous years of precip data that is available for all GPP observations)
GPPYrs = 21
MaxLag = 4
#Initiliase vectors
YearlyCorrelation = rep(0,MaxLag)
YearlyPValue = rep(0,MaxLag)
YearlyMin = rep(0,MaxLag)
YearlyMax = rep(0,MaxLag)
# For each possible lag check correlation of yearly total GPP vs yearly total 
# precipitation

for (i in 1:(MaxLag+1)){
  Stats = cor.test(Ha1$GPP[i:GPPYrs,2],
                   rowSums(Ha1$Precip[1:(GPPYrs-i+1),2:13]),
                   use="complete.obs")
  YearlyCorrelation[i] = Stats$estimate
  YearlyPValue[i] = Stats$p.value<=0.05
  YearlyMin[i] = Stats$conf.int[1]
  YearlyMax[i] = Stats$conf.int[2]
}

# Assemble into dataframe
# Reverse vectors so that from left to right, we are moving further into the past
LagCorrelation = data.frame(0:MaxLag,
                            Correlation=YearlyCorrelation,
                            pValue=YearlyPValue,
                            min = YearlyMin, 
                            max = YearlyMax)

# Plot correlation values with confidence intervals. Color red if p <= 0.05 i.e.
# there is a significant correlation
plot <- ggplot(LagCorrelation,
               aes(x=0:MaxLag,
                   y=Correlation,
                   color=pValue,
                   ymin = min, 
                   ymax = max)) + 
  geom_pointrange() +
  scale_color_continuous(low="black",
                         high="red",
                         guide="none") +
  geom_hline(yintercept=0,
             color="grey",
             linetype='dashed') +
  xlab("Year into Past") +
  ggtitle("Yearly Total Precip vs GPP Correlation (Site: Harvard Forest)")
grid.arrange(plot)
```

Yep, as expected - no correlation.

This correlation check hasn't shown any significant correlation between antecedent
rainfall and productivity at any site but Fort Collins. Is it possible that this
site is an anomaly?

Is it a longer time series that allow the correlations to become significant?

Is it the metric used to measure productivity?

Is it because yearly rainfall isn't a good metric - rain falling in December is
unlikely to affect the productivity of a grassland (or a deciduous forest for that
matter) since it is falling outside of the growing season.

***

## Correlation on growing season rainfall

All 4 of these sites are located in the USA where spring/summer, and hence the 
growing season, occurs roughly between March and August. I will check correlation
between GPP/NPP and MAMJJA rainfall totals for various lag periods.

First we check for Fort Collins and we would expect to see very similar results
to the full year precipitation (productivity is basically restricted to the 
growing season since the NPP is estimated from harvested biomass)

```{r Fort Collins Growing Season Corr}
# Set values for years of NPP data and max possible lag (i.e. max number of 
# previous years of precip data that is available for all NPP observations)
NPPYrs = 52
MaxLag = 40
#Initiliase vectors
YearlyCorrelation = rep(0,MaxLag)
YearlyPValue = rep(0,MaxLag)
YearlyMin = rep(0,MaxLag)
YearlyMax = rep(0,MaxLag)
# For each possible lag (at most we can go 40 years back), check correlation of
# yearly total NPP vs yearly total precipitation
# We have 52 years of NPP so we want 52 years of Precip, hence i:(i+51)

for (i in 1:MaxLag){
  Stats = cor.test(NPP$NPP,rowSums(Precip[i:(i+NPPYrs-1),3:9]),use="complete.obs")
  YearlyCorrelation[i] = Stats$estimate
  YearlyPValue[i] = (Stats$p.value<=0.05)
  YearlyMin[i] = Stats$conf.int[1]
  YearlyMax[i] = Stats$conf.int[2]
}



# Assemble into dataframe
# Reverse vectors so that from left to right, we are moving further into the past
LagCorrelation = data.frame(0:(MaxLag-1),
                    Correlation=rev(YearlyCorrelation),
                    pValue=rev(YearlyPValue),
                    min = rev(YearlyMin), 
                    max = rev(YearlyMax))

# Plot correlation values with confidence intervals. Color red if p <= 0.05 i.e.
# there is a significant correlation
plot <- ggplot(LagCorrelation,aes(x=0:(MaxLag-1),
                          y=Correlation,
                          color=pValue,
                          ymin = min, 
                          ymax = max)) + 
  geom_pointrange() +
  scale_color_continuous(low="black",
                         high="red",
                         guide="none") +
  geom_hline(yintercept=0,
             color="grey",
             linetype='dashed') +
  xlab("Year into Past") +
  ggtitle("Growing Season Precip vs NPP Correlation (Site: Fort Collins)")
grid.arrange(plot)
```


As expected, we still see the significant correlation for lags of length 0 to 3.

Let's check for the FLUXNET sites:

```{r FLUXNET Growing Season Corr GPP}
#******************************************************************************
# SITE: Harvard Forest
#******************************************************************************

# Set values for years of GPP data and max possible lag (i.e. max number of 
# previous years of precip data that is available for all GPP observations)
GPPYrs = 21
MaxLag = 4
#Initiliase vectors
YearlyCorrelation = rep(0,MaxLag)
YearlyPValue = rep(0,MaxLag)
YearlyMin = rep(0,MaxLag)
YearlyMax = rep(0,MaxLag)
# For each possible lag check correlation of yearly total GPP vs yearly total 
# precipitation

for (i in 1:(MaxLag+1)){
  Stats = cor.test(Ha1$GPP[i:GPPYrs,2],
                   rowSums(Ha1$Precip[1:(GPPYrs-i+1),4:9]),
                   use="complete.obs")
  YearlyCorrelation[i] = Stats$estimate
  YearlyPValue[i] = Stats$p.value<=0.05
  YearlyMin[i] = Stats$conf.int[1]
  YearlyMax[i] = Stats$conf.int[2]
}

# Assemble into dataframe
# Reverse vectors so that from left to right, we are moving further into the past
LagCorrelation = data.frame(0:MaxLag,
                            Correlation=YearlyCorrelation,
                            pValue=YearlyPValue,
                            min = YearlyMin, 
                            max = YearlyMax)

# Plot correlation values with confidence intervals. Color red if p <= 0.05 i.e.
# there is a significant correlation
plotHa1 <- ggplot(LagCorrelation,
               aes(x=0:MaxLag,
                   y=Correlation,
                   color=pValue,
                   ymin = min, 
                   ymax = max)) + 
  geom_pointrange() +
  scale_color_continuous(low="black",
                         high="red",
                         guide="none") +
  geom_hline(yintercept=0,
             color="grey",
             linetype='dashed') +
  xlab("Year into Past") +
  ggtitle("Growing Season Precip vs GPP Correlation (Site: Harvard Forest)")

#******************************************************************************
# SITE: Walnut Gulch
#******************************************************************************

# Set values for years of GPP data and max possible lag (i.e. max number of 
# previous years of precip data that is available for all GPP observations)
GPPYrs = 10
MaxLag = 4
#Initiliase vectors
YearlyCorrelation = rep(0,MaxLag)
YearlyPValue = rep(0,MaxLag)
YearlyMin = rep(0,MaxLag)
YearlyMax = rep(0,MaxLag)
# For each possible lag check correlation of yearly total GPP vs yearly total 
# precipitation

for (i in 1:(MaxLag+1)){
  Stats = cor.test(Wkg$GPP[i:GPPYrs,2],
                   rowSums(Wkg$Precip[1:(GPPYrs-i+1),4:9]),
                   use="complete.obs")
  YearlyCorrelation[i] = Stats$estimate
  YearlyPValue[i] = Stats$p.value<=0.05
  YearlyMin[i] = Stats$conf.int[1]
  YearlyMax[i] = Stats$conf.int[2]
}

# Assemble into dataframe
# Reverse vectors so that from left to right, we are moving further into the past
LagCorrelation = data.frame(0:MaxLag,
                            Correlation=YearlyCorrelation,
                            pValue=YearlyPValue,
                            min = YearlyMin, 
                            max = YearlyMax)

# Plot correlation values with confidence intervals. Color red if p <= 0.05 i.e.
# there is a significant correlation
plotWkg <- ggplot(LagCorrelation,
               aes(x=0:MaxLag,
                   y=Correlation,
                   color=pValue,
                   ymin = min, 
                   ymax = max)) + 
  geom_pointrange() +
  scale_color_continuous(low="black",
                         high="red",
                         guide="none") +
  geom_hline(yintercept=0,
             color="grey",
             linetype='dashed') +
  xlab("Year into Past") +
  ggtitle("Growing Season Precip vs GPP Correlation (Site: Walnut Gulch)")

#******************************************************************************
# SITE: Vaira Grasslands
#******************************************************************************

# Set values for years of GPP data and max possible lag (i.e. max number of 
# previous years of precip data that is available for all GPP observations)
GPPYrs = 14
MaxLag = 4
#Initiliase vectors
YearlyCorrelation = rep(0,MaxLag)
YearlyPValue = rep(0,MaxLag)
YearlyMin = rep(0,MaxLag)
YearlyMax = rep(0,MaxLag)
# For each possible lag check correlation of yearly total GPP vs yearly total 
# precipitation

for (i in 1:(MaxLag+1)){
  Stats = cor.test(Var$GPP[i:GPPYrs,2],
                   rowSums(Var$Precip[1:(GPPYrs-i+1),4:9]),
                   use="complete.obs")
  YearlyCorrelation[i] = Stats$estimate
  YearlyPValue[i] = Stats$p.value<=0.05
  YearlyMin[i] = Stats$conf.int[1]
  YearlyMax[i] = Stats$conf.int[2]
}

# Assemble into dataframe
# Reverse vectors so that from left to right, we are moving further into the past
LagCorrelation = data.frame(0:MaxLag,
                            Correlation=YearlyCorrelation,
                            pValue=YearlyPValue,
                            min = YearlyMin, 
                            max = YearlyMax)

# Plot correlation values with confidence intervals. Color red if p <= 0.05 i.e.
# there is a significant correlation
plotVar <- ggplot(LagCorrelation,
               aes(x=0:MaxLag,
                   y=Correlation,
                   color=pValue,
                   ymin = min, 
                   ymax = max)) + 
  geom_pointrange() +
  scale_color_continuous(low="black",
                         high="red",
                         guide="none") +
  geom_hline(yintercept=0,
             color="grey",
             linetype='dashed') +
  xlab("Year into Past") +
  ggtitle("Growing Season Precip vs GPP Correlation (Site: Vaira Grasslands)")

#******************************************************************************
# Plot the graphs
#******************************************************************************

grid.arrange(plotVar,plotWkg,plotHa1,nrow=3)
```

When we look at March - August, the correlations are still non-significant and 
therefore we cannot infer that there is any dependence on antecedent rainfall. 
However, we will check April-June, a smaller window more limited to spring.


```{r FLUXNET AMJ Corr GPP}
#******************************************************************************
# SITE: Harvard Forest
#******************************************************************************

# Set values for years of GPP data and max possible lag (i.e. max number of 
# previous years of precip data that is available for all GPP observations)
GPPYrs = 21
MaxLag = 4
#Initiliase vectors
YearlyCorrelation = rep(0,MaxLag)
YearlyPValue = rep(0,MaxLag)
YearlyMin = rep(0,MaxLag)
YearlyMax = rep(0,MaxLag)
# For each possible lag check correlation of yearly total GPP vs yearly total 
# precipitation

for (i in 1:(MaxLag+1)){
  Stats = cor.test(Ha1$GPP[i:GPPYrs,2],
                   rowSums(Ha1$Precip[1:(GPPYrs-i+1),5:7]),
                   use="complete.obs")
  YearlyCorrelation[i] = Stats$estimate
  YearlyPValue[i] = Stats$p.value<=0.05
  YearlyMin[i] = Stats$conf.int[1]
  YearlyMax[i] = Stats$conf.int[2]
}

# Assemble into dataframe
# Reverse vectors so that from left to right, we are moving further into the past
LagCorrelation = data.frame(0:MaxLag,
                            Correlation=YearlyCorrelation,
                            pValue=YearlyPValue,
                            min = YearlyMin, 
                            max = YearlyMax)

# Plot correlation values with confidence intervals. Color red if p <= 0.05 i.e.
# there is a significant correlation
plotHa1 <- ggplot(LagCorrelation,
               aes(x=0:MaxLag,
                   y=Correlation,
                   color=pValue,
                   ymin = min, 
                   ymax = max)) + 
  geom_pointrange() +
  scale_color_continuous(low="black",
                         high="red",
                         guide="none") +
  geom_hline(yintercept=0,
             color="grey",
             linetype='dashed') +
  xlab("Year into Past") +
  ggtitle("AMJ Precip vs GPP Correlation (Site: Harvard Forest)")

#******************************************************************************
# SITE: Walnut Gulch
#******************************************************************************

# Set values for years of GPP data and max possible lag (i.e. max number of 
# previous years of precip data that is available for all GPP observations)
GPPYrs = 10
MaxLag = 4
#Initiliase vectors
YearlyCorrelation = rep(0,MaxLag)
YearlyPValue = rep(0,MaxLag)
YearlyMin = rep(0,MaxLag)
YearlyMax = rep(0,MaxLag)
# For each possible lag check correlation of yearly total GPP vs yearly total 
# precipitation

for (i in 1:(MaxLag+1)){
  Stats = cor.test(Wkg$GPP[i:GPPYrs,2],
                   rowSums(Wkg$Precip[1:(GPPYrs-i+1),5:7]),
                   use="complete.obs")
  YearlyCorrelation[i] = Stats$estimate
  YearlyPValue[i] = Stats$p.value<=0.05
  YearlyMin[i] = Stats$conf.int[1]
  YearlyMax[i] = Stats$conf.int[2]
}

# Assemble into dataframe
# Reverse vectors so that from left to right, we are moving further into the past
LagCorrelation = data.frame(0:MaxLag,
                            Correlation=YearlyCorrelation,
                            pValue=YearlyPValue,
                            min = YearlyMin, 
                            max = YearlyMax)

# Plot correlation values with confidence intervals. Color red if p <= 0.05 i.e.
# there is a significant correlation
plotWkg <- ggplot(LagCorrelation,
               aes(x=0:MaxLag,
                   y=Correlation,
                   color=pValue,
                   ymin = min, 
                   ymax = max)) + 
  geom_pointrange() +
  scale_color_continuous(low="black",
                         high="red",
                         guide="none") +
  geom_hline(yintercept=0,
             color="grey",
             linetype='dashed') +
  xlab("Year into Past") +
  ggtitle("AMJ Precip vs GPP Correlation (Site: Walnut Gulch)")

#******************************************************************************
# SITE: Vaira Grasslands
#******************************************************************************

# Set values for years of GPP data and max possible lag (i.e. max number of 
# previous years of precip data that is available for all GPP observations)
GPPYrs = 14
MaxLag = 4
#Initiliase vectors
YearlyCorrelation = rep(0,MaxLag)
YearlyPValue = rep(0,MaxLag)
YearlyMin = rep(0,MaxLag)
YearlyMax = rep(0,MaxLag)
# For each possible lag check correlation of yearly total GPP vs yearly total 
# precipitation

for (i in 1:(MaxLag+1)){
  Stats = cor.test(Var$GPP[i:GPPYrs,2],
                   rowSums(Var$Precip[1:(GPPYrs-i+1),5:7]),
                   use="complete.obs")
  YearlyCorrelation[i] = Stats$estimate
  YearlyPValue[i] = Stats$p.value<=0.05
  YearlyMin[i] = Stats$conf.int[1]
  YearlyMax[i] = Stats$conf.int[2]
}

# Assemble into dataframe
# Reverse vectors so that from left to right, we are moving further into the past
LagCorrelation = data.frame(0:MaxLag,
                            Correlation=YearlyCorrelation,
                            pValue=YearlyPValue,
                            min = YearlyMin, 
                            max = YearlyMax)

# Plot correlation values with confidence intervals. Color red if p <= 0.05 i.e.
# there is a significant correlation
plotVar <- ggplot(LagCorrelation,
               aes(x=0:MaxLag,
                   y=Correlation,
                   color=pValue,
                   ymin = min, 
                   ymax = max)) + 
  geom_pointrange() +
  scale_color_continuous(low="black",
                         high="red",
                         guide="none") +
  geom_hline(yintercept=0,
             color="grey",
             linetype='dashed') +
  xlab("Year into Past") +
  ggtitle("AMJ Precip vs GPP Correlation (Site: Vaira Grasslands)")

#******************************************************************************
# Plot the graphs
#******************************************************************************

grid.arrange(plotVar,plotWkg,plotHa1,nrow=3)
```

Still no significant correlations. Note also that in both restricted scenarios, 
Walnut Gulch loses the significance on lag 0 rainfall.

I also tested various other restrictions around March-August of varying length.
These all exhibited very similar results - no significant correlations (Walnut 
Gulch did exhibit a significant correlation for a 4 year lag in one scenario but
I believe this to be an artifact of the short data set)

## Visual Comparison of Graphs

I will have a little gander at plots to see if anything jumps out at me and to 
maybe identify the growing seasons at each site.

The below is a bit of code that might prove useful for checking GPP vs Precip for
sites.

```{r Simple Comparison Plot}
name = "US-Var_2001-2014_FLUXNET2015"


Met = nc_open(paste0(name,"_Met.nc"))
Flux = nc_open(paste0(name,"_Flux.nc"))

time = ncvar_get(Met,"time")
Tair = ncvar_get(Met,"Tair")
PrecipVar = ncvar_get(Met,"Precip")
VPD = ncvar_get(Met,"VPD")
NEE = ncvar_get(Flux,"NEE")
GPP = ncvar_get(Flux,"GPP_DT")

ncatt_get(Met, "time")
time_from = substr(ncatt_get(Met, "time")$units, 15, 33)
time <- as.POSIXct(time, origin=time_from)

nc_close(Met)
nc_close(Flux)

# Define unit conversions
SEC_TO_30MIN = 1800
KEL_TO_CEL = -273.15

# Create data frame with the units converted
# Precip is now in mm
# Tair is now in Celsius
df <- data.frame(time, NEE, GPP, Tair+KEL_TO_CEL,PrecipVar*SEC_TO_30MIN,VPD)
colnames(df)<- c("time","NEE","GPP","Tair","Precip","VPD")


df_day <- df %>%
  mutate(day=as.Date(time, format="%Y-%m-%d")) %>%
  group_by(day) %>%               # group by the day column
  summarise(NEE=sum(NEE),GPP=sum(GPP),Tair=mean(Tair),Precip=sum(Precip),VPD=mean(VPD))


# We normalise the rain and precip to make it easier to compare them
plot(df_day$day,df_day$GPP/max(df_day$GPP,na.rm=TRUE),col='green',type='l')
lines(df_day$day,df_day$Precip/max(df_day$Precip,na.rm=TRUE),col='blue')
```

Just from visual inspection of the above, it is hard to see any relationship 
between precipitation and GPP - peaks in GPP don't seem to follow corresponding
peaks in rainfall.

## Linear Regression

The below code conducts a linear regression for each site 

```{r Linear Regression}

# Model for Vaira Grasslands
NPP_n = Var$GPP$GPP[5:14]/mean(Var$GPP$GPP[5:14],na.rm=TRUE)
Lag0 = unname(rowSums(Var$Precip[5:14,2:13])/mean(rowSums(Var$Precip[5:14,2:13]),na.rm=TRUE))
Lag1 = unname(rowSums(Var$Precip[4:13,2:13])/mean(rowSums(Var$Precip[4:13,2:13]),na.rm=TRUE))
Lag2 = unname(rowSums(Var$Precip[3:12,2:13])/mean(rowSums(Var$Precip[3:12,2:13]),na.rm=TRUE))
Lag3 = unname(rowSums(Var$Precip[2:11,2:13])/mean(rowSums(Var$Precip[2:11,2:13]),na.rm=TRUE))
Lag4 =  unname(rowSums(Var$Precip[1:10,2:13])/mean(rowSums(Var$Precip[1:10,2:13]),na.rm=TRUE))

Model_Var = lm(NPP_n ~ Lag0 + Lag1 + Lag2 + Lag3 + Lag4 - 1)


# Model for Harvard Forest
NPP_n = Ha1$GPP$GPP[5:21]/mean(Ha1$GPP$GPP[5:21],na.rm=TRUE)
Lag0 = unname(rowSums(Ha1$Precip[5:21,2:13])/mean(rowSums(Ha1$Precip[5:21,2:13]),na.rm=TRUE))
Lag1 = unname(rowSums(Ha1$Precip[4:20,2:13])/mean(rowSums(Ha1$Precip[4:20,2:13]),na.rm=TRUE))
Lag2 = unname(rowSums(Ha1$Precip[3:19,2:13])/mean(rowSums(Ha1$Precip[3:19,2:13]),na.rm=TRUE))
Lag3 = unname(rowSums(Ha1$Precip[2:18,2:13])/mean(rowSums(Ha1$Precip[2:18,2:13]),na.rm=TRUE))
Lag4 = unname(rowSums(Ha1$Precip[1:17,2:13])/mean(rowSums(Ha1$Precip[1:17,2:13]),na.rm=TRUE))

Model_Ha1 = lm(NPP_n ~ Lag0 + Lag1 + Lag2 + Lag3 + Lag4 - 1)


# Model for Walnut Gulch
GPP_n = Wkg$GPP$GPP[5:10]/mean(Wkg$GPP$GPP[5:10],na.rm=TRUE)
Lag0 = unname(rowSums(Wkg$Precip[5:10,2:13])/mean(rowSums(Wkg$Precip[5:10,2:13]),na.rm=TRUE))
Lag1 = unname(rowSums(Wkg$Precip[4:9,2:13])/mean(rowSums(Wkg$Precip[4:9,2:13]),na.rm=TRUE))
Lag2 = unname(rowSums(Wkg$Precip[3:8,2:13])/mean(rowSums(Wkg$Precip[3:8,2:13]),na.rm=TRUE)) 
Lag3 = unname(rowSums(Wkg$Precip[2:7,2:13])/mean(rowSums(Wkg$Precip[2:7,2:13]),na.rm=TRUE))
Lag4 = unname(rowSums(Wkg$Precip[1:6,2:13])/mean(rowSums(Wkg$Precip[1:6,2:13]),na.rm=TRUE))

Model_Wkg = lm(GPP_n ~ Lag0+Lag1+Lag2+Lag3+Lag4 - 1)


# Model for Fort Collins
NPP_n = NPP$NPP/mean(NPP$NPP,na.rm=TRUE)
Lag0 = unname(rowSums(Precip[40:91,2:13])/mean(rowSums(Precip[40:91,2:13]),na.rm=TRUE))
Lag1 = unname(rowSums(Precip[39:90,2:13])/mean(rowSums(Precip[39:90,2:13]),na.rm=TRUE))
Lag2 = unname(rowSums(Precip[38:89,2:13])/mean(rowSums(Precip[38:89,2:13]),na.rm=TRUE))
Lag3 = unname(rowSums(Precip[37:88,2:13])/mean(rowSums(Precip[37:88,2:13]),na.rm=TRUE)) 
Lag4 = unname(rowSums(Precip[36:87,2:13])/mean(rowSums(Precip[36:87,2:13]),na.rm=TRUE))
Lag5 = unname(rowSums(Precip[35:86,2:13])/mean(rowSums(Precip[35:86,2:13]),na.rm=TRUE))

Model_FC = lm(NPP_n ~ Lag0 + Lag1 + Lag2 + Lag3 + Lag4 + Lag5 - 1)

# Plot the coefficients
plot(factor(names(Model_FC$coefficients),levels=names(Model_FC$coefficients)),Model_FC$coefficients,xlab = "Lags",ylab="Coefficient",main="Fort Collins Linear Model")
plot(factor(names(Model_Var$coefficients),levels=names(Model_Var$coefficients)),Model_Var$coefficients,xlab = "Lags",ylab="Coefficient",main="Vaira Grasslands Linear Model")
plot(factor(names(Model_Ha1$coefficients),levels=names(Model_Ha1$coefficients)),Model_Ha1$coefficients,xlab = "Lags",ylab="Coefficient",main="Harvard Forest Linear Model")
plot(factor(names(Model_Wkg$coefficients),levels=names(Model_Wkg$coefficients)),Model_Wkg$coefficients,xlab = "Lags",ylab="Coefficient",main="Walnut Gulch Linear Model")

```

## Checking FLUXNET sites close to the Central Plains Experimental Range 

The data from Kiona is from the Central Plains Experimental Range (CPER) which 
is located close to Fort Collins (which is where some of the meteorological data 
was obtained and hence why this data is referred to as Fort Collins in this here
document).

Checking the FLUXNET website (https://fluxnet.fluxdata.org/ accessed 07/04/2020),
there are 3 sites located relatively close to CPER:

+ US-Sta: Saratoga, a Sagebrush steppe ecosystem with 5 years of data
+ US-NR1: Niwot Ridge, a subalpine evergreen needle forest with 17 years of data
+ US-GLE: GLEES, an evergeen needle forest with 11 years of data

The two forests are at nearly twice the elevation of CPER and, combined with the
different vegetation type, are not similar enough.

Saratoga is closer in elevation and has a similar vegetation type but only 5 years
of data. 

Further afield, US-Cop (Corral Pocket) is a semi-arid grassland but again a short
dataset of 7 years and 300+ miles from CPER.